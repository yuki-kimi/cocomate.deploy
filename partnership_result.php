<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

// 質問コードとテキストのマッピング
$question_map = [
    1 => ['a' => '心理的な支え合いや感情的なつながりを重視したい', 'b' => '生活の中でのサポートや、実際的な助け合いが重要', 'c' => '自由で柔軟な関係で、お互いの時間を大切にしたい', 'd' => '家族のような深い絆を築き、親子のような関係を持ちたい'],
    2 => ['a' => '日々の生活を共に楽しみたい（家事や住む場所を一緒にシェアしたい）', 'b' => '自分の時間も大切にしつつ、時々会って楽しく過ごしたい', 'c' => '家庭や育児を一緒に支え合いながら過ごしたい', 'd' => '季節の行事や新しい挑戦、趣味を楽しみたい'],
    3 => ['a' => '日常を共に過ごし、一緒に生活を楽しみたい', 'b' => '週末や特別な日だけ、ゆっくりと一緒に過ごしたい', 'c' => '自由な時間を尊重しながら、お互いのペースで過ごしたい', 'd' => '新しい冒険を共に体験し、わくわくする時間を過ごしたい'],
    4 => ['a' => '人生を楽しめるパートナーとして心の絆を大事にしたい', 'b' => '自由で柔軟に、自分のペースで過ごせるライフスタイルがいい', 'c' => '家族としてのつながりを大切にし、子どもや家庭を育んでいきたい', 'd' => '新しい挑戦や体験を共に楽しみ、成長したい'],
    5 => ['a' => '落ち着いたペースでつながり、会ったときにじっくり向き合いたい', 'b' => 'いつでも自由に連絡を取り合い、気が向いたときに気楽に話せる', 'c' => '毎日連絡を送り合い、日常の小さな出来事もシェアしたい', 'd' => 'お互いのペースを大切にしつつ、必要なときにしっかり話せる'],
    6 => ['a' => 'いつでも支え合い、深い絆でつながっていたい', 'b' => '時にはお互いに支え合いながら、個々の時間も大切にしたい', 'c' => '自由で柔軟な関係で、お互いのペースを尊重したい', 'd' => '生活の一部を共有しながら、お互いに頼れる存在でいたい'],
];

$image_map = [
    'ハートパートナー' => 'partnership_heart.png',
    'ファミリーシップ' => 'partnership_family.png',
    'フレックスパートナー' => 'partnership_flex.png',
    '週末パートナー' => 'partnership_weekend.png',
    'ライフパートナー' => 'partnership_life.png',
    '子育てパートナー' => 'partnership_child.png',
    'ジャーニーメイト' => 'partnership_journey.png',
];

// 各選択肢のスコア
$answers = [
    '心理的な支え合いや感情的なつながりを重視したい' => [
        'ハートパートナー' => 2,
        'ファミリーシップ' => 0,
        'フレックスパートナー' => 0,
        '週末パートナー' => 0,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 0
    ],
    '生活の中でのサポートや、実際的な助け合いが重要' => [
        'ハートパートナー' => 0,
        'ファミリーシップ' => 1,
        'フレックスパートナー' => 0,
        '週末パートナー' => 0,
        'ライフパートナー' => 2,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 0
    ],
    '自由で柔軟な関係で、お互いの時間を大切にしたい' => [
        'ハートパートナー' => 0,
        'ファミリーシップ' => 0,
        'フレックスパートナー' => 2,
        '週末パートナー' => 0,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 0
    ],
    '家族のような深い絆を築き、親子のような関係を持ちたい' => [
        'ハートパートナー' => 0,
        'ファミリーシップ' => 2,
        'フレックスパートナー' => 0,
        '週末パートナー' => 0,
        'ライフパートナー' => 0,
        '子育てパートナー' => 2,
        'ジャーニーメイト' => 0
    ],
    '日々の生活を共に楽しみたい（家事や住む場所を一緒にシェアしたい）' => [
        'ハートパートナー' => 0,
        'ファミリーシップ' => 2,
        'フレックスパートナー' => 0,
        '週末パートナー' => 0,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 0
    ],
    '自分の時間も大切にしつつ、時々会って楽しく過ごしたい' => [
        'ハートパートナー' => 1,
        'ファミリーシップ' => 0,
        'フレックスパートナー' => 0,
        '週末パートナー' => 2,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 2
    ],
    '家庭や育児を一緒に支え合いながら過ごしたい' => [
        'ハートパートナー' => 0,
        'ファミリーシップ' => 2,
        'フレックスパートナー' => 0,
        '週末パートナー' => 0,
        'ライフパートナー' => 0,
        '子育てパートナー' => 2,
        'ジャーニーメイト' => 0
    ],
    '季節の行事や新しい挑戦、趣味を楽しみたい' => [
        'ハートパートナー' => 0,
        'ファミリーシップ' => 0,
        'フレックスパートナー' => 0,
        '週末パートナー' => 2,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 2
    ],
    '日常を共に過ごし、一緒に生活を楽しみたい' => [
        'ハートパートナー' => 0,
        'ファミリーシップ' => 2,
        'フレックスパートナー' => 0,
        '週末パートナー' => 0,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 0
    ],
    '週末や特別な日だけ、ゆっくりと一緒に過ごしたい' => [
        'ハートパートナー' => 1,
        'ファミリーシップ' => 0,
        'フレックスパートナー' => 0,
        '週末パートナー' => 2,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 1
    ],
    '自由な時間を尊重しながら、お互いのペースで過ごしたい' => [
        'ハートパートナー' => 1,
        'ファミリーシップ' => 0,
        'フレックスパートナー' => 2,
        '週末パートナー' => 0,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 0
    ],
    '新しい冒険を共に体験し、わくわくする時間を過ごしたい' => [
        'ハートパートナー' => 0,
        'ファミリーシップ' => 0,
        'フレックスパートナー' => 0,
        '週末パートナー' => 0,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 2
    ],
    '人生を楽しめるパートナーとして心の絆を大事にしたい' => [
        'ハートパートナー' => 2,
        'ファミリーシップ' => 0,
        'フレックスパートナー' => 0,
        '週末パートナー' => 0,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 0
    ],
    '自由で柔軟に、自分のペースで過ごせるライフスタイルがいい' => [
        'ハートパートナー' => 0,
        'ファミリーシップ' => 0,
        'フレックスパートナー' => 2,
        '週末パートナー' => 0,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 0
    ],
    '家族としてのつながりを大切にし、子どもや家庭を育んでいきたい' => [
        'ハートパートナー' => 0,
        'ファミリーシップ' => 2,
        'フレックスパートナー' => 0,
        '週末パートナー' => 0,
        'ライフパートナー' => 0,
        '子育てパートナー' => 2,
        'ジャーニーメイト' => 0
    ],
    '新しい挑戦や体験を共に楽しみ、成長したい' => [
        'ハートパートナー' => 0,
        'ファミリーシップ' => 0,
        'フレックスパートナー' => 0,
        '週末パートナー' => 0,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 2
    ],
    '落ち着いたペースでつながり、会ったときにじっくり向き合いたい' => [
        'ハートパートナー' => 2,
        'ファミリーシップ' => 0,
        'フレックスパートナー' => 0,
        '週末パートナー' => 1,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 0
    ],
    'いつでも自由に連絡を取り合い、気が向いたときに気楽に話せる' => [
        'ハートパートナー' => 1,
        'ファミリーシップ' => 0,
        'フレックスパートナー' => 0,
        '週末パートナー' => 0,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 0
    ],
    '毎日連絡を送り合い、日常の小さな出来事もシェアしたい' => [
        'ハートパートナー' => 0,
        'ファミリーシップ' => 2,
        'フレックスパートナー' => 0,
        '週末パートナー' => 0,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 0
    ],
    'お互いのペースを大切にしつつ、必要なときにしっかり話せる' => [
        'ハートパートナー' => 2,
        'ファミリーシップ' => 0,
        'フレックスパートナー' => 1,
        '週末パートナー' => 0,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 0
    ],
    'いつでも支え合い、深い絆でつながっていたい' => [
        'ハートパートナー' => 0,
        'ファミリーシップ' => 2,
        'フレックスパートナー' => 0,
        '週末パートナー' => 0,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 0
    ],
    '時にはお互いに支え合いながら、個々の時間も大切にしたい' => [
        'ハートパートナー' => 0,
        'ファミリーシップ' => 0,
        'フレックスパートナー' => 1,
        '週末パートナー' => 0,
        'ライフパートナー' => 2,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 0
    ],
    '自由で柔軟な関係で、お互いのペースを尊重したい' => [
        'ハートパートナー' => 1,
        'ファミリーシップ' => 0,
        'フレックスパートナー' => 2,
        '週末パートナー' => 1,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 0
    ],
    '生活の一部を共有しながら、お互いに頼れる存在でいたい' => [
        'ハートパートナー' => 0,
        'ファミリーシップ' => 2,
        'フレックスパートナー' => 0,
        '週末パートナー' => 0,
        'ライフパートナー' => 0,
        '子育てパートナー' => 0,
        'ジャーニーメイト' => 0
    ]
];


// ユーザー回答を文章に変換
$user_answers = [];
for ($i = 1; $i <= 6; $i++) {
    $key = 'q' . $i;
    if (isset($_POST[$key])) {
        $code = $_POST[$key];
        $sentence = $question_map[$i][$code] ?? '';
        if (!empty($sentence)) {
            $user_answers[] = $sentence;
        }
    }
}

// スコア集計
$scores = [];
foreach ($user_answers as $answer) {
    if (isset($answers[$answer])) {
        foreach ($answers[$answer] as $type => $score) {
            if (!isset($scores[$type])) {
                $scores[$type] = 0;
            }
            $scores[$type] += $score;
        }
    }
}

// 上位3つを取得
arsort($scores);
$partner_types = array_slice(array_keys($scores), 0, 3);

error_reporting(E_ALL);
ini_set('display_errors', 1);

// 回答コード → 日本語文章に変換
$question_map = [
    1 => ['a' => '心理的な支え合いや感情的なつながりを重視したい', 'b' => '生活の中でのサポートや、実際的な助け合いが重要', 'c' => '自由で柔軟な関係で、お互いの時間を大切にしたい', 'd' => '家族のような深い絆を築き、親子のような関係を持ちたい'],
    2 => ['a' => '日々の生活を共に楽しみたい（家事や住む場所を一緒にシェアしたい）', 'b' => '自分の時間も大切にしつつ、時々会って楽しく過ごしたい', 'c' => '家庭や育児を一緒に支え合いながら過ごしたい', 'd' => '季節の行事や新しい挑戦、趣味を楽しみたい'],
    3 => ['a' => '日常を共に過ごし、一緒に生活を楽しみたい', 'b' => '週末や特別な日だけ、ゆっくりと一緒に過ごしたい', 'c' => '自由な時間を尊重しながら、お互いのペースで過ごしたい', 'd' => '新しい冒険を共に体験し、わくわくする時間を過ごしたい'],
    4 => ['a' => '人生を楽しめるパートナーとして心の絆を大事にしたい', 'b' => '自由で柔軟に、自分のペースで過ごせるライフスタイルがいい', 'c' => '家族としてのつながりを大切にし、子どもや家庭を育んでいきたい', 'd' => '新しい挑戦や体験を共に楽しみ、成長したい'],
    5 => ['a' => '落ち着いたペースでつながり、会ったときにじっくり向き合いたい', 'b' => 'いつでも自由に連絡を取り合い、気が向いたときに気楽に話せる', 'c' => '毎日連絡を送り合い、日常の小さな出来事もシェアしたい', 'd' => 'お互いのペースを大切にしつつ、必要なときにしっかり話せる'],
    6 => ['a' => 'いつでも支え合い、深い絆でつながっていたい', 'b' => '時にはお互いに支え合いながら、個々の時間も大切にしたい', 'c' => '自由で柔軟な関係で、お互いのペースを尊重したい', 'd' => '生活の一部を共有しながら、お互いに頼れる存在でいたい'],
];

// ユーザーの回答を取得して文章に変換
$user_answers = [];
for ($i = 1; $i <= 6; $i++) {
    $key = 'q' . $i;
    if (isset($_POST[$key])) {
        $code = $_POST[$key];
        $sentence = $question_map[$i][$code] ?? '';
        if (!empty($sentence)) {
            $user_answers[] = $sentence;
        }
    }
}

// ChatGPT APIを使って提案文を生成

function generateRecommendationText($answers) {
    $api_key = ''; 
        $messages = [
        ['role' => 'system', 'content' => 'あなたは40代の女性の心理カウンセラーです。'],
        ['role' => 'user', 'content' =>
            "以下の情報をもとに、その人らしいパートナーシップの提案文をカウンセラーのように優しく、温かみのある文章で書いてください。" .
            "「あなたはもしかしたら〜かもしれません」という語り口でお願いします。また、文章量は200文字程度にまとめてください。\n" .
            implode("\n", array_map(function ($q, $a) { return "Q{$q}: {$a}"; }, range(1, 6), $answers))
        ]
    ];

    $data = [
        'model' => 'gpt-4o-mini',
        'messages' => $messages,
        'temperature' => 0.8
    ];

    $ch = curl_init('https://api.openai.com/v1/chat/completions');
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        'Content-Type: application/json',
        'Authorization: Bearer ' . $api_key
    ]);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));

    $response = curl_exec($ch);
    curl_close($ch);

    if ($response) {
        $result = json_decode($response, true);
    
        // // デバッグ用（任意で残してもOK）
        // echo '<pre>';
        // print_r($result);
        // echo '</pre>';
    
        if (isset($result['choices'][0]['message']['content'])) {
            return $result['choices'][0]['message']['content'];
        } else {
            return '文章の取得に失敗しました（contentが見つかりません）';
        }
    } else {
        return 'API呼び出しに失敗しました。';
    }

}

// 実行して文章を取得
$recommendation_text = generateRecommendationText($user_answers);
?>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>診断結果</title>
    <style>
body {
    font-family: 'メイリオ', sans-serif;
    background-color: #f7f7f7;
    margin: 0;
    padding: 30px;
    /* display: flex; を削除 */
}

.container {
    width: 900px;
    max-width: 100%;
    margin: 0 auto; /* 中央寄せ */
}

.header-image {
    text-align: center;
    margin-bottom: 30px;
}

.header-image img {
    max-width: 100%;
    height: auto;
}

.result-header {
    display: flex;
    justify-content: space-between;
    background-color: #fff;
    padding: 5px;
    width: 100%; /* containerに合わせる */
    gap: 10px;
    flex-wrap: nowrap;
}

.partner-box {
    flex: 1;
    text-align: center;
}

.partner-image {
    width: 100%;
    height: auto;
    border-radius: 12px;
}

.result-message {
    background-color: #fffaf6;
    border-left: 5px solid  #f28c8c;
    padding: 20px;
    margin-top: 30px;
    border-radius: 10px;
    width: 100%; /* container幅にあわせる */
}

.result-message h3 {
    color:  #f28c8c;
    font-size: 1.4em;
    margin-bottom: 10px;
}

.back-button {
    text-align: center;
    margin-top: 30px;
}

.back-button a {
    display: inline-block;
    background-color: #f28c8c;
    color: #fff;
    text-decoration: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: bold;
    transition: background-color 0.3s;
}

.back-button a:hover {
    background-color:rgb(245, 179, 179);
}


    </style>
</head>
<body>
<div class="container">

    <!-- メイン画像 -->
    <div class="header-image">
        <img src="img/diagnosis_result_main.png" alt="診断結果画像">
    </div>

    <!-- パートナーシップ画像3つ -->
    <div class="result-header">
        <?php foreach ($partner_types as $type): ?>
            <div class="partner-box">
                <img src="img/<?php echo $image_map[$type]; ?>" alt="<?php echo htmlspecialchars($type); ?>" class="partner-image">
            </div>
        <?php endforeach; ?>
    </div>

    <!-- メッセージ -->
    <div class="result-message">
        <h3>あなたへのメッセージ</h3>
        <p><?php echo nl2br(htmlspecialchars($recommendation_text)); ?></p>
    </div>

    <!-- トップに戻る -->
    <div class="back-button">
        <a href="index.php">トップに戻る</a>
    </div>

</div>

</body>


</html>




